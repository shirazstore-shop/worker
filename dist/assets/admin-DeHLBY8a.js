import{c as p,A as h,f as w}from"./script-_tmyBgT7.js";const r=p({baseUrl:h.baseUrl});let i=[],s=[],u=[],m=[];document.addEventListener("DOMContentLoaded",async()=>{await E()});async function E(){const t=document.getElementById("authContainer"),e=document.getElementById("adminPanel");try{if((await r.auth.getSession()).data?.user){const d=await(await r.api.fetch("/api/users/sync",{method:"POST"})).json();if(d.success&&d.data?.user?.role!=="admin"&&d.data?.user?.role!=="database_admin"){t.innerHTML=`
          <div class="auth-container" style="text-align: center;">
            <h2 style="color: #dc2626; margin-bottom: 16px;">Access Denied</h2>
            <p style="margin-bottom: 24px;">You do not have permission to access the admin panel.</p>
            <button onclick="handleLogout()" class="btn btn-primary">Sign Out</button>
            <br><br>
            <a href="/" class="btn btn-secondary">Go Home</a>
          </div>
        `,t.classList.remove("hidden"),e.classList.add("hidden");return}t.classList.add("hidden"),e.classList.remove("hidden"),await I()}else t.classList.remove("hidden"),e.classList.add("hidden"),await r.auth.renderAuthUI(t,{redirectTo:window.location.href})}catch(o){console.error("Auth error:",o),t.innerHTML='<div class="alert alert-error">Authentication error. Please refresh the page.</div>'}}async function I(){await Promise.all([v(),l(),M(),y()]),g()}window.handleLogout=async function(){try{await r.auth.signOut(),window.location.reload()}catch(t){console.error("Logout error:",t)}};window.showSection=function(t){document.querySelectorAll('[id$="Section"]').forEach(o=>o.classList.add("hidden"));const e=document.getElementById(`${t}Section`);e&&e.classList.remove("hidden"),document.querySelectorAll(".admin-nav-link").forEach(o=>{o.classList.toggle("active",o.dataset.section===t)})};window.toggleAdminSidebar=function(){document.getElementById("adminSidebar").classList.toggle("mobile-open")};async function v(){try{const e=await(await r.api.fetch("/api/devices")).json();e.success&&(i=e.data||[],B(),b())}catch(t){console.error("Failed to load devices:",t)}}function B(){const t=document.getElementById("devicesTableBody");if(!i.length){t.innerHTML='<tr><td colspan="6" class="text-center text-muted">No devices found</td></tr>';return}t.innerHTML=i.map(e=>`
    <tr>
      <td>${e.model}</td>
      <td>${e.name}</td>
      <td>${e.color}</td>
      <td>${e.storage}</td>
      <td>${e.price}</td>
      <td>
        <button class="btn-icon" onclick="editDevice(${e.id})" title="Edit">
          <i class="fas fa-edit"></i>
        </button>
        <button class="btn-icon" onclick="deleteDevice(${e.id})" title="Delete" style="color: #dc2626;">
          <i class="fas fa-trash"></i>
        </button>
      </td>
    </tr>
  `).join("")}window.deleteDevice=async function(t){if(confirm("Are you sure you want to delete this device?"))try{const o=await(await r.api.fetch(`/api/devices/${t}`,{method:"DELETE"})).json();if(!o.success)throw new Error(o.message||"Failed to delete");await v()}catch(e){console.error("Delete error:",e),alert("Failed to delete device")}};function b(){const t=document.getElementById("orderDevice");t&&(t.innerHTML=`
    <option value="">Select Device</option>
    ${i.map(e=>`<option value="${e.id}">${e.name} - ${e.model||""}</option>`).join("")}
  `)}window.showDeviceModal=function(t=null){if(document.getElementById("deviceModalTitle").textContent=t?"Edit Device":"Add Device",document.getElementById("deviceId").value=t||"",t){const e=i.find(o=>o.id===t);e&&(document.getElementById("deviceModel").value=e.model,document.getElementById("deviceName").value=e.name,document.getElementById("deviceDescription").value=e.description,document.getElementById("deviceColor").value=e.color,document.getElementById("deviceStorage").value=e.storage,document.getElementById("devicePrice").value=e.price,document.getElementById("deviceImageUrl").value=e.imageUrl||"")}else document.getElementById("deviceForm").reset(),document.getElementById("deviceColor").value="On admin activation",document.getElementById("deviceStorage").value="On admin activation",document.getElementById("devicePrice").value="Sponsored";openModal("deviceModal")};window.editDevice=function(t){showDeviceModal(t)};window.saveDevice=async function(){const t=document.getElementById("deviceId").value,e={model:document.getElementById("deviceModel").value,name:document.getElementById("deviceName").value,description:document.getElementById("deviceDescription").value,color:document.getElementById("deviceColor").value,storage:document.getElementById("deviceStorage").value,price:document.getElementById("devicePrice").value,imageUrl:document.getElementById("deviceImageUrl").value};try{const o=t?`/api/devices/${t}`:"/api/devices",n=t?"PUT":"POST",a=await(await r.api.fetch(o,{method:n,headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();if(!a.success)throw new Error(a.message||"Failed to save device");closeModal("deviceModal"),await v()}catch(o){console.error("Save device error:",o),alert("Failed to save device")}};async function l(){try{const e=await(await r.api.fetch("/api/orders")).json();e.success&&(s=e.data||[],T(),g())}catch(t){console.error("Failed to load orders:",t)}}function T(){const t=document.getElementById("ordersTableBody");if(!s.length){t.innerHTML='<tr><td colspan="6" class="text-center text-muted">No orders found</td></tr>';return}t.innerHTML=s.map(e=>{const o=e.order||e,n=e.device||i.find(d=>d.id===o.deviceId);return`
      <tr>
        <td><strong>${o.orderNumber}</strong></td>
        <td>${o.customerName}</td>
        <td>${n?n.name:"Unknown"}</td>
        <td><span class="tracking-status status-${o.status}">${o.status}</span></td>
        <td>${w(o.createdAt)}</td>
        <td>
          <button class="btn-icon" onclick="editOrder(${o.id})" title="Edit">
            <i class="fas fa-edit"></i>
          </button>
          <button class="btn-icon" onclick="showEventModal(${o.id})" title="Add Event">
            <i class="fas fa-plus-circle"></i>
          </button>
          <button class="btn-icon" onclick="deleteOrder(${o.id})" title="Delete" style="color: #dc2626;">
            <i class="fas fa-trash"></i>
          </button>
        </td>
      </tr>
    `}).join("")}window.deleteOrder=async function(t){if(confirm("Are you sure you want to delete this order? This will also delete all tracking events."))try{const o=await(await r.api.fetch(`/api/orders/${t}`,{method:"DELETE"})).json();if(!o.success)throw new Error(o.message||"Failed to delete");await l()}catch(e){console.error("Delete error:",e),alert("Failed to delete order")}};function g(){const t=s.map(e=>e.order||e);document.getElementById("totalOrders").textContent=t.length,document.getElementById("pendingOrders").textContent=t.filter(e=>e.status==="pending").length,document.getElementById("shippedOrders").textContent=t.filter(e=>e.status==="shipped").length,document.getElementById("deliveredOrders").textContent=t.filter(e=>e.status==="delivered").length}window.showOrderModal=function(t=null){if(document.getElementById("orderModalTitle").textContent=t?"Edit Order":"New Order",document.getElementById("orderId").value=t||"",t){const e=s.find(n=>(n.order?.id||n.id)===t),o=e?.order||e;o&&(o.deviceId?document.getElementById("orderDevice").value=o.deviceId:document.getElementById("orderDevice").value="",document.getElementById("orderCustomerName").value=o.customerName,document.getElementById("orderCustomerEmail").value=o.customerEmail||"",document.getElementById("orderCustomerPhone").value=o.customerPhone||"",document.getElementById("orderShippingAddress").value=o.shippingAddress,document.getElementById("orderColor").value=o.color||"",document.getElementById("orderStorage").value=o.storage||"",document.getElementById("orderTrackingNumber").value=o.trackingNumber||"",document.getElementById("orderStatus").value=o.status,document.getElementById("orderNotes").value=o.notes||"",document.getElementById("orderNumber").value=o.orderNumber||"",document.getElementById("orderWaybill").value=o.waybill||"",document.getElementById("orderPackageDimensions").value=o.packageDimensions||"",document.getElementById("orderSenderInfo").value=o.senderInfo||"",document.getElementById("orderReceiverInfo").value=o.receiverInfo||"")}else document.getElementById("orderForm").reset(),document.getElementById("orderDevice").value="";openModal("orderModal")};window.editOrder=function(t){showOrderModal(t)};window.saveOrder=async function(){const t=document.getElementById("orderId").value,e=document.getElementById("orderDevice").value,o=e?parseInt(e):null;if(!o){alert("Please select a device");return}const n={deviceId:o,customerName:document.getElementById("orderCustomerName").value,customerEmail:document.getElementById("orderCustomerEmail").value,customerPhone:document.getElementById("orderCustomerPhone").value,shippingAddress:document.getElementById("orderShippingAddress").value,color:document.getElementById("orderColor").value,storage:document.getElementById("orderStorage").value,trackingNumber:document.getElementById("orderTrackingNumber").value,status:document.getElementById("orderStatus").value,notes:document.getElementById("orderNotes").value,orderNumber:document.getElementById("orderNumber").value,waybill:document.getElementById("orderWaybill").value,packageDimensions:document.getElementById("orderPackageDimensions").value,senderInfo:document.getElementById("orderSenderInfo").value,receiverInfo:document.getElementById("orderReceiverInfo").value};try{const d=t?`/api/orders/${t}`:"/api/orders",a=t?"PUT":"POST",f=await(await r.api.fetch(d,{method:a,headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})).json();if(!f.success)throw new Error(f.message||"Failed to save order");closeModal("orderModal"),await l()}catch(d){console.error("Save order error:",d),alert("Failed to save order")}};window.showEventModal=function(t){document.getElementById("eventOrderId").value=t,document.getElementById("eventForm").reset(),document.getElementById("eventDate").value=new Date().toISOString().split("T")[0],openModal("eventModal")};window.saveEvent=async function(){const t=document.getElementById("eventOrderId").value,e={date:document.getElementById("eventDate").value,location:document.getElementById("eventLocation").value,description:document.getElementById("eventDescription").value,updateStatus:document.getElementById("eventUpdateStatus").value||null};try{const n=await(await r.api.fetch(`/api/orders/${t}/events`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})).json();if(!n.success)throw new Error(n.message||"Failed to add event");closeModal("eventModal"),await l(),alert("Tracking event added successfully")}catch(o){console.error("Save event error:",o),alert("Failed to add event")}};async function M(){try{const e=await(await r.api.fetch("/api/users")).json();e.success&&(u=e.data||[],x())}catch(t){console.error("Failed to load users:",t)}}function x(){const t=document.getElementById("usersTableBody");if(!u.length){t.innerHTML='<tr><td colspan="4" class="text-center text-muted">No users found</td></tr>';return}t.innerHTML=u.map(e=>`
    <tr>
      <td>${e.name||"N/A"}</td>
      <td>${e.email}</td>
      <td>
        <select onchange="updateRole(${e.id}, this.value)" class="form-select" style="width: auto; padding: 4px 8px;">
          <option value="user" ${e.role==="user"?"selected":""}>User</option>
          <option value="admin" ${e.role==="admin"?"selected":""}>Admin</option>
          <option value="database_admin" ${e.role==="database_admin"?"selected":""}>Database Admin</option>
        </select>
      </td>
      <td>
        <button class="btn-sm btn-primary" onclick="showLinkOrderModal(${e.id})">Link Order</button>
      </td>
    </tr>
  `).join("")}window.updateRole=async function(t,e){try{await r.api.fetch(`/api/users/${t}/role`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({role:e})})}catch(o){console.error("Update role error:",o),alert("Failed to update role")}};window.showLinkOrderModal=function(t){document.getElementById("linkUserId").value=t,document.getElementById("linkOrderForm").reset(),openModal("linkOrderModal")};window.saveLinkOrder=async function(){const t=document.getElementById("linkUserId").value,e=document.getElementById("linkOrderIdentifier").value;try{const n=await(await r.api.fetch("/api/users/link-order",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:t,orderIdentifier:e})})).json();if(!n.success)throw new Error(n.message||"Failed to link order");closeModal("linkOrderModal"),alert("Order linked successfully")}catch(o){console.error("Link order error:",o),alert("Failed to link order. Check if order exists.")}};async function y(){try{const e=await(await r.api.fetch("/api/assets")).json();e.success&&(m=e.data||[],D())}catch(t){console.error("Failed to load assets:",t)}}function D(){const t=document.getElementById("assetsGrid");if(!m.length){t.innerHTML='<div style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">No assets uploaded</div>';return}t.innerHTML=m.map(e=>`
    <div class="device-card" style="padding: 10px; position: relative;">
      <div style="height: 100px; display: flex; align-items: center; justify-content: center; background: #f5f5f7; border-radius: 8px; margin-bottom: 10px; overflow: hidden;">
        ${e.mimeType?.startsWith("image/")?`<img src="${e.downloadUrl}" style="max-width: 100%; max-height: 100%; object-fit: contain;">`:e.mimeType?.includes("text/")||e.mimeType?.includes("json")||e.mimeType?.includes("javascript")||e.filename.endsWith(".js")||e.filename.endsWith(".css")||e.filename.endsWith(".html")?'<i class="fas fa-code" style="font-size: 32px; color: var(--text-secondary);"></i>':'<i class="fas fa-file" style="font-size: 32px; color: var(--text-secondary);"></i>'}
      </div>
      <div style="font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${e.filename}</div>
      <div style="font-size: 10px; color: var(--text-secondary);">${k(e.size)}</div>
      <div style="margin-top: 8px; display: flex; gap: 5px;">
        <button class="btn-sm" onclick="copyToClipboard('${e.downloadUrl}')" title="Copy URL" style="flex: 1;"><i class="fas fa-link"></i></button>
        <a href="${e.downloadUrl}" target="_blank" class="btn-sm" title="Download" style="flex: 1; display: flex; align-items: center; justify-content: center; text-decoration: none; color: inherit; background: #f0f0f0;"><i class="fas fa-download"></i></a>
        <button class="btn-sm" onclick="deleteAsset(${e.id})" title="Delete" style="flex: 1; color: #d32f2f;"><i class="fas fa-trash"></i></button>
      </div>
    </div>
  `).join("")}window.handleFileUpload=async function(t){const e=t.target.files[0];if(!e)return;const o=new FormData;o.append("file",e);try{const n=t.target.parentElement,d=n.innerHTML;n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Uploading...';const c=await(await r.api.fetch("/api/assets/upload",{method:"POST",body:o})).json();if(!c.success)throw new Error(c.message||"Upload failed");await y(),n.innerHTML=d}catch(n){console.error("Upload error:",n),alert("Failed to upload file"),t.target.parentElement.innerHTML='<i class="fas fa-upload"></i> Upload File <input type="file" id="fileInput" style="display: none;" onchange="handleFileUpload(event)">'}};window.deleteAsset=async function(t){if(confirm("Are you sure you want to delete this asset?"))try{const o=await(await r.api.fetch(`/api/assets/${t}`,{method:"DELETE"})).json();if(!o.success)throw new Error(o.message||"Failed to delete asset");await y()}catch(e){console.error("Delete asset error:",e),alert("Failed to delete asset")}};window.copyToClipboard=function(t){navigator.clipboard.writeText(t).then(()=>{alert("URL copied to clipboard")})};function k(t,e=2){if(!+t)return"0 Bytes";const o=1024,n=e<0?0:e,d=["Bytes","KB","MB","GB","TB"],a=Math.floor(Math.log(t)/Math.log(o));return`${parseFloat((t/Math.pow(o,a)).toFixed(n))} ${d[a]}`}window.openModal=function(t){document.getElementById(t).classList.add("active")};window.closeModal=function(t){document.getElementById(t).classList.remove("active")};document.querySelectorAll(".modal-overlay").forEach(t=>{t.addEventListener("click",e=>{e.target===t&&t.classList.remove("active")})});
